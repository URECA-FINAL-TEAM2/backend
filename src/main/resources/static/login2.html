<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Management Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js"></script>
</head>
<body>
<div id="app">
    <h1>로그인 예제</h1>
    <div id="loginForm" style="margin-bottom: 20px;">
        <input type="text" id="username" placeholder="사용자명">
        <input type="password" id="password" placeholder="비밀번호">
        <button onclick="login()">로그인</button>
    </div>

    <div id="userInfo" style="display: none;">
        <h2>사용자 정보</h2>
        <p>사용자 ID: <span id="userId"></span></p>
        <p>닉네임: <span id="nickname"></span></p>
        <button onclick="logout()">로그아웃</button>
    </div>

    <div id="notifications" style="margin-top: 20px;">
        <h2>알림</h2>
        <div id="notificationList"></div>
    </div>
</div>

<script>
    let eventSource = null;

    // AES 복호화 함수
    function decryptToken(encryptedToken, key) {
        try {
            const decrypted = CryptoJS.AES.decrypt(encryptedToken, key);
            return decrypted.toString(CryptoJS.enc.Utf8);
        } catch (error) {
            console.error('Decryption error:', error);
            return null;
        }
    }

    // 로그인 함수
    async function login() {
        try {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const response = await axios.post('/api/login', {
                username: username,
                password: password
            });

            const {
                encrypted_access_token,
                decryption_key,
                userId,
                nickname
            } = response.data;

            // 토큰 정보 저장
            sessionStorage.setItem('decryption_key', decryption_key);
            sessionStorage.setItem('user_id', userId);

            // UI 업데이트
            document.getElementById('userId').textContent = userId;
            document.getElementById('nickname').textContent = nickname;
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';

            // SSE 연결 시작
            connectSSE();
        } catch (error) {
            console.error('Login error:', error);
            alert('로그인 실패');
        }
    }

    // SSE 연결 함수
    function connectSSE() {
        const userId = sessionStorage.getItem('user_id');
        const roleType = 'USER'; // 또는 다른 역할
        const encryptedToken = getCookie('access_token');

        if (eventSource) {
            eventSource.close();
        }

        eventSource = new EventSource(
            `/notifications/connect?userId=${userId}&roleType=${roleType}&encryptedToken=${encryptedToken}`
        );

        eventSource.onmessage = (event) => {
            const notification = JSON.parse(event.data);
            addNotification(notification);
        };

        eventSource.onerror = (error) => {
            console.error('SSE connection error:', error);
            eventSource.close();
            // 토큰 만료 시 리프레시 토큰으로 새로운 액세스 토큰 요청
            refreshToken();
        };
    }

    // 토큰 리프레시 함수
    async function refreshToken() {
        try {
            const refreshToken = getCookie('refresh_token');
            const response = await axios.post('/api/refresh', {
                encryptedRefreshToken: refreshToken
            });

            const {
                encrypted_access_token,
                decryption_key
            } = response.data;

            sessionStorage.setItem('decryption_key', decryption_key);

            // SSE 재연결
            connectSSE();
        } catch (error) {
            console.error('Token refresh error:', error);
            // 리프레시 토큰도 만료된 경우 로그아웃
            logout();
        }
    }

    // 쿠키 가져오기 함수
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // 알림 추가 함수
    function addNotification(notification) {
        const notificationList = document.getElementById('notificationList');
        const notificationElement = document.createElement('div');
        notificationElement.className = 'notification';
        notificationElement.innerHTML = `
                <p>${notification.message}</p>
                <small>${new Date(notification.timestamp).toLocaleString()}</small>
            `;
        notificationList.prepend(notificationElement);
    }

    // 로그아웃 함수
    function logout() {
        if (eventSource) {
            eventSource.close();
        }
        sessionStorage.clear();
        document.cookie.split(";").forEach(cookie => {
            document.cookie = cookie.replace(/^ +/, "")
                .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
        });
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('userInfo').style.display = 'none';
        document.getElementById('notificationList').innerHTML = '';
    }
</script>

<style>
    .notification {
        border: 1px solid #ddd;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
    }

    .notification small {
        color: #666;
        display: block;
        margin-top: 5px;
    }

    input, button {
        margin: 5px;
        padding: 8px;
    }

    button {
        cursor: pointer;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
    }

    button:hover {
        background-color: #45a049;
    }
</style>
</body>
</html>